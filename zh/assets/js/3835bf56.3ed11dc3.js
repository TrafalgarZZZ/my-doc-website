"use strict";(self.webpackChunkmy_doc_website=self.webpackChunkmy_doc_website||[]).push([[3844],{6064:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>a});var r=i(7624),d=i(2172);const o={sidebar_label:"Setting up Fluid Development Environment with Kind on MacOS",sidebar_position:2},s="Setting up Fluid Development Environment with Kind on MacOS",t={id:"developer-manual/dev_with_kind",title:"Setting up Fluid Development Environment with Kind on MacOS",description:"+ kind (version > v0.10.0)",source:"@site/docs/developer-manual/dev_with_kind.md",sourceDirName:"developer-manual",slug:"/developer-manual/dev_with_kind",permalink:"/my-doc-website/zh/docs/developer-manual/dev_with_kind",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/developer-manual/dev_with_kind.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_label:"Setting up Fluid Development Environment with Kind on MacOS",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Fluid\u5f00\u53d1\u6587\u6863",permalink:"/my-doc-website/zh/docs/developer-manual/how_to_develop"},next:{title:"\u4f7f\u7528 pprof \u5bf9 Fluid \u7ec4\u4ef6\u8fdb\u884c\u6027\u80fd\u5206\u6790",permalink:"/my-doc-website/zh/docs/developer-manual/pprof"}},l={},a=[{value:"1. download go source code",id:"1-download-go-source-code",level:2},{value:"2. create kind cluster",id:"2-create-kind-cluster",level:2},{value:"3. create fluid crds and csi driver to kind cluster",id:"3-create-fluid-crds-and-csi-driver-to-kind-cluster",level:2},{value:"4.  download helm and create soft link charts",id:"4--download-helm-and-create-soft-link-charts",level:2},{value:"5. run csi-driver and node-driver-registrar code in kind node container",id:"5-run-csi-driver-and-node-driver-registrar-code-in-kind-node-container",level:2},{value:"6. start alluxio and dataset on Mac",id:"6-start-alluxio-and-dataset-on-mac",level:2},{value:"7. load image to kind cluster",id:"7-load-image-to-kind-cluster",level:2},{value:"8. run fluid demo",id:"8-run-fluid-demo",level:2}];function c(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,d.M)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"setting-up-fluid-development-environment-with-kind-on-macos",children:"Setting up Fluid Development Environment with Kind on MacOS"}),"\n",(0,r.jsx)(n.h1,{id:"requirements",children:"Requirements"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"kind (version > v0.10.0)"}),"\n",(0,r.jsx)(n.li,{children:"docker"}),"\n",(0,r.jsx)(n.li,{children:"MacOS"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"csi-driver"})," and ",(0,r.jsx)(n.code,{children:"node-driver-registrar"}),"(sidecar) need to communicate with kubelet,",(0,r.jsx)(n.br,{}),"\n","so run them in kind container"]}),"\n",(0,r.jsx)(n.h1,{id:"set-up-steps",children:"Set up steps"}),"\n",(0,r.jsx)(n.h2,{id:"1-download-go-source-code",children:"1. download go source code"}),"\n",(0,r.jsxs)(n.p,{children:["In order to run ",(0,r.jsx)(n.code,{children:"csi-driver"})," and ",(0,r.jsx)(n.code,{children:"node-driver-registrar"})," code in kind container",(0,r.jsx)(n.br,{}),"\n","download it from ",(0,r.jsx)(n.a,{href:"https://golang.org/dl/go1.16.3.linux-amd64.tar.gz",children:"go1.16.3.linux-amd64.tar.gz"}),"\ndecompress it and put it in ",(0,r.jsx)(n.code,{children:"~/go/local/"})," directory"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"  ~/go\n    |__bin\n    |__pkg\n    |__src\n    |   |__ github.com\n    |   |__ sigs.k8s.io\n    |   |__ k8s.io\n    |__local\n    |  |__go \n"})}),"\n",(0,r.jsx)(n.h2,{id:"2-create-kind-cluster",children:"2. create kind cluster"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ kind create cluster --config=cluster.yaml\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# cluster.yaml\nkind: Cluster\napiVersion: kind.x-k8s.io/v1alpha4\nname: fluid-dev\nnodes:\n- role: control-plane\n  image: kindest/node:v1.16.1\n  extraMounts:\n  - hostPath: /your/Mac/go/path # GOPATH value on Mac\n    containerPath: /home/work/go\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# check kind cluster node\n$ kubectl get nodes\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"NAME                      STATUS   ROLES    AGE   VERSION\nfluid-dev-control-plane   Ready    master   74s   v1.16.15\n"})}),"\n",(0,r.jsx)(n.h2,{id:"3-create-fluid-crds-and-csi-driver-to-kind-cluster",children:"3. create fluid crds and csi driver to kind cluster"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"alluxioruntimes.data.fluid.io"}),"\n",(0,r.jsx)(n.li,{children:"databackups.data.fluid.io"}),"\n",(0,r.jsx)(n.li,{children:"dataloads.data.fluid.io"}),"\n",(0,r.jsx)(n.li,{children:"datasets.data.fluid.io"}),"\n",(0,r.jsx)(n.li,{children:"jindoruntimes.data.fluid.io"}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/fluid-cloudnative/fluid/blob/master/charts/fluid/fluid/templates/csi/driver.yaml",children:"fuse.csi.fluid.io"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ cd ~/go/src/github.com/fluid-cloudnative/fluid\n$ kustomize build config/crd/ | kubectl apply -f -\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"customresourcedefinition.apiextensions.k8s.io/alluxioruntimes.data.fluid.io created\ncustomresourcedefinition.apiextensions.k8s.io/databackups.data.fluid.io created\ncustomresourcedefinition.apiextensions.k8s.io/dataloads.data.fluid.io created\ncustomresourcedefinition.apiextensions.k8s.io/datasets.data.fluid.io created\ncustomresourcedefinition.apiextensions.k8s.io/jindoruntimes.data.fluid.io created\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ kubectl apply -f ./csi/deploy/csi-fluid-driver.yaml\n$ kubectl get csidriver\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"NAME                CREATED AT\nfuse.csi.fluid.io   2021-04-24T15:30:38Z\n"})}),"\n",(0,r.jsx)(n.h2,{id:"4--download-helm-and-create-soft-link-charts",children:"4.  download helm and create soft link charts"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# download helm to ~/tmp/ unpack it and move to ~/go/bin\n$ cd ~/tmp/ && curl https://get.helm.sh/helm-v3.6.2-darwin-amd64.tar.gz -o helm-v3.6.2-darwin-amd64.tar.gz\n$ tar xzvf helm-v3.6.2-darwin-amd64.tar.gz  && cp darwin-amd64/helm ~/go/bin/ddc-helm\n\n# create charts soft link\n$ ln -s ~/go/src/github.com/fluid-cloudnative/fluid/charts ~/charts \n"})}),"\n",(0,r.jsx)(n.h2,{id:"5-run-csi-driver-and-node-driver-registrar-code-in-kind-node-container",children:"5. run csi-driver and node-driver-registrar code in kind node container"}),"\n",(0,r.jsx)(n.p,{children:"start fluid csi driver"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker exec -ti fluid-dev-control-plane /bin/bash\ncd /home/work/go/src/github.com/fluid-cloudnative/fluid/cmd/csi && sh start.sh\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'#! /bin/bash\nset -x\n\nexport TMPDIR=/root/go/tmp\nexport GO111MODULE=on\nexport GOMODCACHE=/root/go/pkg/mod\nexport GOPROXY=https://goproxy.io\nexport GOPATH=/home/work/go\nexport GOROOT=/home/work/go/local/go\nexport GOBIN=/home/work/go/bin\nexport PATH=$PATH:$GOBIN:$GOROOT/bin\n\nif [ ! -d $TMPDIR ]; then\n  mkdir -p $TMPDIR\nfi\n\n\nrm -f /var/lib/kubelet/csi-plugins/fuse.csi.fluid.io/csi.sock\nmkdir -p /var/lib/kubelet/csi-plugins/fuse.csi.fluid.io\n\ncp /home/work/go/src/github.com/allenhaozi/fluid/csi/shell/check_mount.sh /usr/local/bin/check_mount.sh && chmod +x /usr/local/bin/check_mount.sh \n\n/home/work/go/local/go/bin/go run main.go start \\\n\t--endpoint="unix://var/lib/kubelet/csi-plugins/fuse.csi.fluid.io/csi.sock" \\\n    --nodeid="fluid-dev-control-plane" \\\n\t--kubeconfig=/etc/kubernetes/kubelet.conf \\\n\t--v=5\n'})}),"\n",(0,r.jsx)(n.p,{children:"start node-driver-registrar"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["I made a small change to ",(0,r.jsx)(n.a,{href:"https://github.com/kubernetes-csi/node-driver-registrar/tree/v1.3.0",children:"node-driver-registrar"})," based on v1.3.0,",(0,r.jsx)(n.br,{}),"\n","It can be downloaded from ",(0,r.jsx)(n.a,{href:"https://github.com/allenhaozi/node-driver-registrar/tree/feat/fluid-dev-v1.3.0",children:"fluid-dev-v1.3.0"}),(0,r.jsx)(n.br,{}),"\n","The only change is to allow passing ",(0,r.jsx)(n.code,{children:"reg-path"})," in arguments",(0,r.jsx)(n.br,{}),"\n","Does not affect the csi-driver online"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"docker exec -ti fluid-dev-control-plane /bin/bash\n$ cd /home/work/go/src/github.com/allenhaozi/node-driver-registrar/cmd/csi-node-driver-registrar && sh start.sh\n\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'#! /bin/bash\nset -x\n\nexport TMPDIR=/root/go/tmp\nexport GO111MODULE=on\nexport GOMODCACHE=/root/go/pkg/mod\nexport GOPROXY=https://goproxy.io\nexport GOPATH=/home/work/go\nexport GOROOT=/home/work/go/local/go\nexport GOBIN=/home/work/go/bin\nexport PATH=$PATH:$GOBIN:$GOROOT/bin\n\nif [ ! -d $TMPDIR ]; then\n  mkdir -p $TMPDIR\nfi\n\n\n# delete reg socket if exist\nrm -rf /var/lib/kubelet/plugins_registry/fuse.csi.fluid.io-reg.sock\n\ngo run main.go \\\n\t--kubelet-registration-path="/var/lib/kubelet/csi-plugins/fuse.csi.fluid.io/csi.sock" \\\n\t--csi-address="/var/lib/kubelet/csi-plugins/fuse.csi.fluid.io/csi.sock" \\\n    --reg-path="/var/lib/kubelet/plugins_registry" \\\n    --v=5\n'})}),"\n",(0,r.jsx)(n.h2,{id:"6-start-alluxio-and-dataset-on-mac",children:"6. start alluxio and dataset on Mac"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"cd ~/go/src/github.com/fluid-cloudnative/fluid/cmd/alluxio && sh start.sh\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"###\n### start.sh\n###\n#! /bin/bash\n\nexport ALLUXIO_INIT_IMAGE_ENV=registry.cn-hangzhou.aliyuncs.com/fluid/init-users:v0.4.0-a8ba7c9\nexport MOUNT_ROOT=/alluxio-mnt\ngo run main.go start\n\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"cd ~/go/src/github.com/fluid-cloudnative/fluid/cmd/dataset && sh start.sh\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"###\n### start.sh\n###\n#! /bin/bash\n\nexport ALLUXIO_INIT_IMAGE_ENV=registry.cn-hangzhou.aliyuncs.com/fluid/init-users:v0.4.0-a8ba7c9\ngo run main.go start \\\n   --metrics-addr=127.0.0.1:8082\n"})}),"\n",(0,r.jsx)(n.h2,{id:"7-load-image-to-kind-cluster",children:"7. load image to kind cluster"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"kind load docker-image registry.cn-hangzhou.aliyuncs.com/fluid/init-users:v0.4.0-a8ba7c9 --name=fluid-dev\nkind load docker-image registry.cn-huhehaote.aliyuncs.com/alluxio/alluxio:2.3.0-SNAPSHOT-2c41226 --name=fluid-dev\nkind load docker-image registry.cn-huhehaote.aliyuncs.com/alluxio/alluxio-fuse:2.3.0-SNAPSHOT-2c41226 --name=fluid-dev                                 \nkind load docker-image nginx:latest --name=fluid-dev\n"})}),"\n",(0,r.jsx)(n.h2,{id:"8-run-fluid-demo",children:"8. run fluid demo"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"$ kubectl apply -f dataset.yaml\n$ kubectl apply -f runtime.yaml\n$ kubectl apply -f pod.yaml\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# check pod list\nNAME                READY   STATUS    RESTARTS   AGE\ndemo-app            1/1     Running   0          31m\ndemo-fuse-ksdsr     1/1     Running   0          31m\ndemo-master-0       2/2     Running   0          36m\ndemo-worker-k2xhh   2/2     Running   0          31m\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# check data\n$ kubectl exec -ti demo-app sh\n$ ls /data/spark/\n\nSparkR_3.0.2.tar.gz   spark-3.0.2-bin-hadoop2.7-hive1.2.tgz  spark-3.0.2-bin-hadoop3.2.tgz  spark-3.0.2.tgz\npyspark-3.0.2.tar.gz  spark-3.0.2-bin-hadoop2.7.tgz      spark-3.0.2-bin-without-hadoop.tgz\n"})})]})}function u(e={}){const{wrapper:n}={...(0,d.M)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},2172:(e,n,i)=>{i.d(n,{I:()=>t,M:()=>s});var r=i(1504);const d={},o=r.createContext(d);function s(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:s(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);